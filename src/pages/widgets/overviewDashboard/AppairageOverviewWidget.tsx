// src/pages/widgets/overviewDashboard/AppairageOverviewWidget.tsx
import * as React from "react";
import {
  AppairageFilters,
  AppairageGroupRow,
  getErrorMessage,
  resolveAppairageGroupLabel,
  useAppairageGrouped,
  useAppairageOverview,
} from "../../../types/appairageStats";
import {
  Box,
  Typography,
  Select,
  MenuItem,
  CircularProgress,
  Alert,
  Card,
  FormControl,
} from "@mui/material";
import AssignmentIcon from "@mui/icons-material/Assignment";
import {
  BarChart,
  Bar,
  CartesianGrid,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  Legend,
  LabelList,
  Cell,
} from "recharts";

/* Utils */
function fmt(n?: number | null) {
  return n == null ? "—" : Math.round(n).toString();
}

export default function AppairageOverviewWidget({
  defaultFilters,
  showFilters = true,
}: {
  defaultFilters?: AppairageFilters;
  showFilters?: boolean;
}) {
  const [filters, setFilters] = React.useState<AppairageFilters>(
    defaultFilters ?? {}
  );

  const { data, isLoading, error } = useAppairageOverview(filters);

  const { data: centresGrouped, isLoading: loadingCentres } =
    useAppairageGrouped("centre", { ...filters, centre: undefined });

  const { data: depsGrouped } = useAppairageGrouped("departement", {
    ...filters,
    departement: undefined,
  });

  const centreOptions =
    centresGrouped?.results?.flatMap((r: AppairageGroupRow) => {
      const id =
        r.formation__centre_id ??
        (typeof r.group_key === "number" || typeof r.group_key === "string"
          ? r.group_key
          : undefined);
      return id != null
        ? [{ id: String(id), label: resolveAppairageGroupLabel(r, "centre") }]
        : [];
    }) ?? [];

  const departementOptions =
    depsGrouped?.results?.flatMap((r: AppairageGroupRow) => {
      const code =
        (typeof r.departement === "string" && r.departement) ||
        (typeof r.group_key === "string" ? r.group_key : "");
      return code
        ? [{ code, label: resolveAppairageGroupLabel(r, "departement") }]
        : [];
    }) ?? [];

  const total = data?.kpis.appairages_total ?? 0;
  const statuts = data?.kpis.statuts ?? {};
  const chartData = [
    { name: "À faire", value: statuts["a_faire"] ?? 0, color: "#ffa726" },
    { name: "Transmis", value: statuts["transmis"] ?? 0, color: "#42a5f5" },
    { name: "En attente", value: statuts["en_attente"] ?? 0, color: "#ab47bc" },
    { name: "OK", value: statuts["appairage_ok"] ?? 0, color: "#66bb6a" },
  ];

  return (
    <Card
      sx={{
        p: 2,
        display: "flex",
        flexDirection: "column",
        gap: 2,
        borderRadius: 2,
        height: "100%",
      }}
    >
      {/* Header */}
      <Box display="flex" alignItems="center" gap={1}>
        <AssignmentIcon color="primary" />
        <Typography variant="subtitle2" fontWeight="bold">
          Appairages
        </Typography>
      </Box>

      {/* Filtres */}
      {showFilters && (
        <Box display="flex" gap={1} flexWrap="wrap">
          <FormControl size="small" sx={{ minWidth: 120 }}>
            <Select
              value={filters.centre ? String(filters.centre) : ""}
              onChange={(e) =>
                setFilters((f) => ({
                  ...f,
                  centre: e.target.value || undefined,
                }))
              }
              disabled={loadingCentres}
              displayEmpty
            >
              <MenuItem value="">Tous centres</MenuItem>
              {centreOptions.map((c) => (
                <MenuItem key={c.id} value={c.id}>
                  {c.label}
                </MenuItem>
              ))}
            </Select>
          </FormControl>

          <FormControl size="small" sx={{ minWidth: 120 }}>
            <Select
              value={filters.departement ?? ""}
              onChange={(e) =>
                setFilters((f) => ({
                  ...f,
                  departement: e.target.value || undefined,
                }))
              }
              displayEmpty
            >
              <MenuItem value="">Tous dépts</MenuItem>
              {departementOptions.map((d) => (
                <MenuItem key={d.code} value={d.code}>
                  {d.label}
                </MenuItem>
              ))}
            </Select>
          </FormControl>
        </Box>
      )}

      {/* KPI global */}
      <Box display="flex" alignItems="center" gap={1}>
        <Typography variant="h6">{fmt(total)}</Typography>
        <Typography variant="body2" color="text.secondary">
          Total
        </Typography>
      </Box>

      {/* Chart */}
      {isLoading ? (
        <Box display="flex" justifyContent="center" p={3}>
          <CircularProgress size={22} />
        </Box>
      ) : error ? (
        <Alert severity="error">{getErrorMessage(error)}</Alert>
      ) : (
        <Box sx={{ height: 240 }}>
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={chartData} barSize={32}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} />
              <XAxis dataKey="name" />
              <YAxis allowDecimals={false} />
              <Tooltip formatter={(v) => `${v} appairages`} />
              <Legend
                verticalAlign="bottom"
                height={30}
                iconType="circle"
                wrapperStyle={{ fontSize: 11 }}
              />
              <Bar dataKey="value">
                {chartData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.color} />
                ))}
                <LabelList dataKey="value" position="top" style={{ fontSize: 11 }} />
              </Bar>
            </BarChart>
          </ResponsiveContainer>
        </Box>
      )}
    </Card>
  );
}
